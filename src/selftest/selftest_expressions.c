#ifdef WINDOWS

#include "selftest_local.h".

void Test_Expressions_RunTests_Basic() {
	// reset whole device
	CMD_ExecuteCommand("clearAll", 0);

	// parser must be able to both handle '-' as an operation and '-' as a negative sign before number
	SELFTEST_ASSERT(Float_Equals(CMD_EvaluateExpression("-1",0), -1.0f));
	SELFTEST_ASSERT(Float_Equals(CMD_EvaluateExpression("-11", 0), -11.0f));

	SELFTEST_ASSERT_EXPRESSION("-1-1", -2);
	SELFTEST_ASSERT_EXPRESSION("1-1", 0);
	SELFTEST_ASSERT_EXPRESSION("1+1", 2);
	SELFTEST_ASSERT_EXPRESSION("-1.0-1.0", -2);
	// same as above but with spaces
	SELFTEST_ASSERT_EXPRESSION("-1 -1", -2);
	SELFTEST_ASSERT_EXPRESSION("1 - 1", 0);
	SELFTEST_ASSERT_EXPRESSION("1 + 1", 2);
	SELFTEST_ASSERT_EXPRESSION(" 1 + 1 ", 2);
	SELFTEST_ASSERT_EXPRESSION("-1.0 -1.0", -2);
	SELFTEST_ASSERT_EXPRESSION("-1.0 - 1.0", -2);
	// multiply
	SELFTEST_ASSERT_EXPRESSION("5*10", 50);
	SELFTEST_ASSERT_EXPRESSION("10*5", 50);
	SELFTEST_ASSERT_EXPRESSION("10*0.5", 5);
	SELFTEST_ASSERT_EXPRESSION("0.5*10", 5);
	SELFTEST_ASSERT_EXPRESSION("0.5*0.5", 0.25);
	// same as above but with spaces
	SELFTEST_ASSERT_EXPRESSION("5*  10", 50);
	SELFTEST_ASSERT_EXPRESSION("10  *5", 50);
	SELFTEST_ASSERT_EXPRESSION("10  *0.5", 5);
	SELFTEST_ASSERT_EXPRESSION("0.5   *   10", 5);
	SELFTEST_ASSERT_EXPRESSION("   0.5  *  0.5  ", 0.25);
	// test spaces
	SELFTEST_ASSERT_EXPRESSION("10.0", 10.0f);
	SELFTEST_ASSERT_EXPRESSION("  10.0   ", 10.0f);
	SELFTEST_ASSERT_EXPRESSION("  10.0*2   ", 20.0f);
	SELFTEST_ASSERT_EXPRESSION("  10.0*2.4   ", 24.0f);
	SELFTEST_ASSERT_EXPRESSION("  10.0+2.4   ", 12.40f);
	SELFTEST_ASSERT_EXPRESSION("  10.0+ 3.4   ", 13.40f);
	SELFTEST_ASSERT_EXPRESSION("  10.0 + 4.4   ", 14.40f);
	CHANNEL_Set(12, 10, 0);

	SELFTEST_ASSERT_EXPRESSION("$CH12*10.0", 100.0f);
	SELFTEST_ASSERT_EXPRESSION("$CH12+10.0", 20.0f);
	SELFTEST_ASSERT_EXPRESSION("10.0+$CH12", 20.0f);
	SELFTEST_ASSERT_EXPRESSION("10.0+$CH12 \r\n", 20.0f);
	SELFTEST_ASSERT_EXPRESSION("10.0+$CH12\n\r", 20.0f);

	// same as above but channel 1 instead of 12 and value 1 instead of 10
	CHANNEL_Set(1, 1, 0);
	SELFTEST_ASSERT_EXPRESSION("$CH1*10.0", 10.0f);
	SELFTEST_ASSERT_EXPRESSION("$CH1+10.0", 11.0f);
	SELFTEST_ASSERT_EXPRESSION("10.0+$CH1", 11.0f);
	SELFTEST_ASSERT_EXPRESSION("10.0+$CH1 \r\n", 11.0f);
	SELFTEST_ASSERT_EXPRESSION("10.0+$CH1\n\r", 11.0f);

	CHANNEL_Set(18, 15, 0);
	SELFTEST_ASSERT_EXPRESSION("15.0+$CH18\n\r", 30.0f);
	SELFTEST_ASSERT_EXPRESSION("15.0/$CH18\n\r", 1.0f);
	SELFTEST_ASSERT_EXPRESSION("1.50/$CH18\n\r", 0.1f);

	// Logical operators
	// &&
	SELFTEST_ASSERT_EXPRESSION("1&&1\n\r", 1.0f);
	SELFTEST_ASSERT_EXPRESSION("1&&0\n\r", 0.0f);
	SELFTEST_ASSERT_EXPRESSION("0&&0\n\r", 0.0f);
	SELFTEST_ASSERT_EXPRESSION("0&&1\n\r", 0.0f);
	// ||
	SELFTEST_ASSERT_EXPRESSION("1||1\n\r", 1.0f);
	SELFTEST_ASSERT_EXPRESSION("1||0\n\r", 1.0f);
	SELFTEST_ASSERT_EXPRESSION("0||0\n\r", 0.0f);
	SELFTEST_ASSERT_EXPRESSION("0||1\n\r", 1.0f);
	// Channel 1 is 1, it was set to 1 above
	// &&
	SELFTEST_ASSERT_EXPRESSION("$CH1&&$CH1\n\r", 1.0f);
	SELFTEST_ASSERT_EXPRESSION("$CH1&&0\n\r", 0.0f);
	SELFTEST_ASSERT_EXPRESSION("0&&0\n\r", 0.0f);
	SELFTEST_ASSERT_EXPRESSION("0&&$CH1\n\r", 0.0f);
	// ||
	SELFTEST_ASSERT_EXPRESSION("$CH1||$CH1\n\r", 1.0f);
	SELFTEST_ASSERT_EXPRESSION("$CH1||0\n\r", 1.0f);
	SELFTEST_ASSERT_EXPRESSION("0||0\n\r", 0.0f);
	SELFTEST_ASSERT_EXPRESSION("0||$CH1\n\r", 1.0f);
	// set $CH1 to 0
	CHANNEL_Set(1, 0, 0);
	// &&
	SELFTEST_ASSERT_EXPRESSION("1&&1\n\r", 1.0f);
	SELFTEST_ASSERT_EXPRESSION("1&&$CH1\n\r", 0.0f);
	SELFTEST_ASSERT_EXPRESSION("$CH1&&$CH1\n\r", 0.0f);
	SELFTEST_ASSERT_EXPRESSION("$CH1&&1\n\r", 0.0f);
	// ||
	SELFTEST_ASSERT_EXPRESSION("1||1\n\r", 1.0f);
	SELFTEST_ASSERT_EXPRESSION("1||$CH1\n\r", 1.0f);
	SELFTEST_ASSERT_EXPRESSION("$CH1||$CH1\n\r", 0.0f);
	SELFTEST_ASSERT_EXPRESSION("$CH1||1\n\r", 1.0f);

	// Logical operators
	// !
	SELFTEST_ASSERT_EXPRESSION("!0\n\r", 1.0f);
	SELFTEST_ASSERT_EXPRESSION("!1\n\r", 0.0f);
}

#endif
